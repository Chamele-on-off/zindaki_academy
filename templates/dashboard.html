@socketio.on('join')
def handle_join(data):
    if 'user' not in session:
        emit('error', {'message': 'Unauthorized'})
        return
    
    room = data.get('room')
    if not room:
        emit('error', {'message': 'Room not specified'})
        return
    
    user = session['user']['username']
    join_room(room)
    user_rooms[request.sid] = room
    
    if room not in active_conferences:
        active_conferences[room] = {
            'teacher': user if session['user']['role'] == 'teacher' else None,
            'started_at': datetime.now().isoformat(),
            'participants': []
        }
    
    if user not in active_conferences[room]['participants']:
        active_conferences[room]['participants'].append(user)
    
    # Отправляем обновленный список участников всем в комнате
    emit('user-joined', {
        'user': user,
        'participants': active_conferences[room]['participants']
    }, room=room)
    logger.info(f'User {user} joined room {room}')