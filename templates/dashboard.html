<!DOCTYPE html>
<html>
<head>
    <title>Video Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        video {
            background: #000;
            width: 400px;
            height: 300px;
            border-radius: 4px;
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 10px 15px;
            margin-right: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Video Chat</h1>
    
    <div id="video-container">
        <div>
            <video id="localVideo" autoplay muted></video>
            <div>You</div>
        </div>
        <div>
            <video id="remoteVideo" autoplay></video>
            <div>Partner</div>
        </div>
    </div>
    
    <div class="controls">
        <input type="text" id="roomInput" placeholder="Room name" value="test-room">
        <button id="startBtn">Start Call</button>
        <button id="joinBtn">Join Call</button>
        <button id="leaveBtn" disabled>Leave</button>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        let peerConnection;
        let localStream;
        const roomInput = document.getElementById('roomInput');
        const startBtn = document.getElementById('startBtn');
        const joinBtn = document.getElementById('joinBtn');
        const leaveBtn = document.getElementById('leaveBtn');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');

        // Configuration for ICE servers
        const config = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // Initialize local video stream
        async function initLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                return true;
            } catch (err) {
                console.error('Error accessing media devices:', err);
                alert('Could not access camera/microphone');
                return false;
            }
        }

        // Create peer connection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            
            // Add local stream to connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
            
            // Handle remote stream
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };
            
            // Handle ICE candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        candidate: event.candidate,
                        room: roomInput.value
                    });
                }
            };
        }

        // Start call as caller
        async function startCall() {
            const room = roomInput.value.trim();
            if (!room) {
                alert('Please enter room name');
                return;
            }
            
            const hasStream = await initLocalStream();
            if (!hasStream) return;
            
            createPeerConnection();
            
            // Create offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            
            socket.emit('offer', {
                sdp: offer,
                room: room
            });
            
            startBtn.disabled = true;
            joinBtn.disabled = true;
            leaveBtn.disabled = false;
        }

        // Join call as callee
        async function joinCall() {
            const room = roomInput.value.trim();
            if (!room) {
                alert('Please enter room name');
                return;
            }
            
            const hasStream = await initLocalStream();
            if (!hasStream) return;
            
            createPeerConnection();
            
            socket.emit('join', { room: room });
            
            startBtn.disabled = true;
            joinBtn.disabled = true;
            leaveBtn.disabled = false;
        }

        // Leave call
        function leaveCall() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localVideo.srcObject = null;
            }
            
            remoteVideo.srcObject = null;
            
            socket.emit('leave', { room: roomInput.value });
            
            startBtn.disabled = false;
            joinBtn.disabled = false;
            leaveBtn.disabled = true;
        }

        // Socket event handlers
        socket.on('offer', async data => {
            if (!peerConnection) createPeerConnection();
            
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            
            socket.emit('answer', {
                sdp: answer,
                room: data.room
            });
        });

        socket.on('answer', async data => {
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
            }
        });

        socket.on('ice-candidate', async data => {
            if (peerConnection && data.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (err) {
                    console.error('Error adding ICE candidate:', err);
                }
            }
        });

        socket.on('user-left', () => {
            alert('Other user left the call');
            leaveCall();
        });

        // Button event listeners
        startBtn.addEventListener('click', startCall);
        joinBtn.addEventListener('click', joinCall);
        leaveBtn.addEventListener('click', leaveCall);

        // Handle page unload
        window.addEventListener('beforeunload', leaveCall);
    </script>
</body>
</html>